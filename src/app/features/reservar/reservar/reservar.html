<div class="min-h-screen bg-[#f2f2f2] px-4 py-8">
    <div class="max-w-3xl mx-auto space-y-6">
        <div class="flex items-center justify-between gap-4">
            <div>
                <p class="text-xs font-medium text-primary uppercase tracking-wide">
                    Reservas
                </p>
                <h1 class="text-2xl font-bold text-foreground">
                    Nueva reserva
                </h1>
                <p class="text-sm text-foreground/70 mt-1">
                    Selecciona la fecha, hora y profesional para tu próxima atención.
                </p>
            </div>

            <a
                    routerLink="/dashboard"
                    class="text-xs font-medium text-primary hover:underline"
            >
                Volver al dashboard
            </a>
        </div>

        <div
                class="bg-white rounded-2xl shadow-lg shadow-foreground/5 border border-primary/10 p-6 sm:p-8"
        >
            <ng-container *ngIf="!lastReservation; else reservationSummary">
                <form
                        [formGroup]="reservationForm"
                        (ngSubmit)="onSubmit()"
                        class="space-y-4"
                >
                    <div class="flex flex-col gap-1.5">
                        <label class="text-sm font-medium text-foreground" for="date">
                            Fecha
                        </label>
                        <input
                                id="date"
                                type="date"
                                formControlName="date"
                                class="w-full rounded-xl border border-foreground/10 bg-[#f9fafb] px-3 py-2.5 text-sm text-foreground outline-none
                     focus:border-primary focus:ring-2 focus:ring-primary/20 transition"
                        />
                        <p
                                *ngIf="date?.touched && date?.errors?.['required']"
                                class="text-xs text-red-500 mt-1"
                        >
                            La fecha es obligatoria.
                        </p>
                        <p
                                *ngIf="date?.touched && date?.errors?.['pastDate']"
                                class="text-xs text-red-500 mt-1"
                        >
                            Fecha inválida
                        </p>
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <label class="text-sm font-medium text-foreground" for="time">
                            Hora
                        </label>
                        <input
                                id="time"
                                type="time"
                                formControlName="time"
                                class="w-full rounded-xl border border-foreground/10 bg-[#f9fafb] px-3 py-2.5 text-sm text-foreground outline-none
                     focus:border-primary focus:ring-2 focus:ring-primary/20 transition"
                        />
                        <p
                                *ngIf="time?.touched && time?.invalid"
                                class="text-xs text-red-500 mt-1"
                        >
                            La hora es obligatoria.
                        </p>
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <label class="text-sm font-medium text-foreground" for="specialty">
                            Especialidad
                        </label>
                        <select
                                id="specialty"
                                formControlName="specialty"
                                (change)="onSpecialtyChange()"
                                class="w-full rounded-xl border border-foreground/10 bg-[#f9fafb] px-3 py-2.5 text-sm text-foreground outline-none
                     focus:border-primary focus:ring-2 focus:ring-primary/20 transition"
                        >
                            <option [ngValue]="null" disabled>Selecciona una especialidad</option>
                            <option
                                    *ngFor="let s of specialties"
                                    [ngValue]="s.id"
                            >
                                {{ s.name }}
                            </option>
                        </select>
                        <p
                                *ngIf="specialty?.touched && specialty?.invalid"
                                class="text-xs text-red-500 mt-1"
                        >
                            Debes seleccionar una especialidad.
                        </p>
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <label class="text-sm font-medium text-foreground" for="doctor">
                            Profesional
                        </label>
                        <select
                                id="doctorId"
                                formControlName="doctorId"
                                (change)="onDoctorChange()"
                                class="w-full rounded-xl border border-foreground/10 bg-[#f9fafb] px-3 py-2.5 text-sm text-foreground outline-none
                     focus:border-primary focus:ring-2 focus:ring-primary/20 transition"
                                [disabled]="!doctorsForSelected.length"
                        >
                            <option [ngValue]="null" disabled>
                                {{ doctorsForSelected.length ? 'Selecciona un profesional' : 'Selecciona primero una especialidad' }}
                            </option>
                            <option
                                    *ngFor="let d of doctorsForSelected"
                                    [ngValue]="d.id"
                            >
                                {{ d.name }}
                            </option>
                        </select>
                        <p
                                *ngIf="doctorId?.touched && doctorId?.invalid"
                                class="text-xs text-red-500 mt-1"
                        >
                            Debes seleccionar un profesional.
                        </p>
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <label class="text-sm font-medium text-foreground" for="reason">
                            Motivo de la consulta
                        </label>
                        <textarea
                                id="reason"
                                formControlName="reason"
                                rows="3"
                                class="w-full rounded-xl border border-foreground/10 bg-[#f9fafb] px-3 py-2.5 text-sm text-foreground outline-none
                     focus:border-primary focus:ring-2 focus:ring-primary/20 transition resize-none"
                                placeholder="Opcional, pero ayuda al profesional a prepararse"
                        ></textarea>
                    </div>

                    <div class="pt-2 flex items-center justify-between gap-4">
                        <button
                                type="submit"
                                class="inline-flex items-center justify-center gap-2 rounded-xl
                     bg-gradient-to-r from-primary to-accent
                     px-4 py-2.5 text-sm font-semibold text-white shadow-md shadow-primary/30
                     hover:shadow-lg hover:brightness-105 active:scale-[0.99] transition
                     disabled:opacity-60 disabled:cursor-not-allowed"
                        >
                            Confirmar reserva
                        </button>

                        <p *ngIf="successMessage" class="text-xs text-foreground/70">
                            {{ successMessage }}
                        </p>
                    </div>
                </form>
            </ng-container>

            <ng-template #reservationSummary>
                <div class="space-y-4" *ngIf="lastReservation as r">
                    <div>
                        <h2 class="text-lg font-semibold text-foreground">
                            Reserva confirmada
                        </h2>
                        <p class="text-sm text-foreground/70 mt-1">
                            Estos son los datos de tu reserva:
                        </p>
                    </div>

                    <div class="space-y-2 text-sm text-foreground">
                        <p>
                            <span class="font-medium">Paciente:</span>
                            {{ r.patientName }}
                        </p>
                        <p>
                            <span class="font-medium">Fecha y hora:</span>
                            {{ r.date }} · {{ r.time }}
                        </p>
                        <p>
                            <span class="font-medium">Especialidad:</span>
                            {{ r.specialty }}
                        </p>
                        <p>
                            <span class="font-medium">Profesional:</span>
                            {{ r.doctorName }}
                        </p>
                        <p *ngIf="r.reason">
                            <span class="font-medium">Motivo:</span>
                            {{ r.reason }}
                        </p>
                    </div>

                    <div class="pt-2 flex items-center justify-between gap-4">
                        <button
                                type="button"
                                (click)="resetForm()"
                                class="inline-flex items-center justify-center gap-2 rounded-xl
                     border border-primary/40 bg-white text-primary
                     px-4 py-2.5 text-sm font-semibold hover:bg-primary/5 transition"
                        >
                            Realizar otra reserva
                        </button>

                        <a
                                routerLink="/mis-reservas"
                                class="text-xs font-medium text-primary hover:underline"
                        >
                            Ver mis reservas
                        </a>
                    </div>
                </div>
            </ng-template>
        </div>
    </div>
</div>
